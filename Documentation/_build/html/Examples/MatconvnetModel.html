

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Matconvnet Model tutorial &mdash; OpenDenoising 0.1 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/underscore.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
        <script type="text/javascript" src="../_static/language_data.js"></script>
        <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
        <script type="text/x-mathjax-config">MathJax.Hub.Config({"tex2jax": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true, "ignoreClass": "document", "processClass": "math|output_area"}})</script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Matlab Model tutorial" href="MatlabModel.html" />
    <link rel="prev" title="Pytorch Model tutorial" href="PytorchModel.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> OpenDenoising
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../installation.html">Installation guide.</a></li>
<li class="toctree-l1"><a class="reference internal" href="../benchmark_api_doc.html">Benchmark API</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../examples.html">Examples</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../examples.html#basic-examples">Basic Examples</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../examples.html#in-depth-tutorials">In-depth Tutorials</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="FilteringModel.html">Filtering Model tutorial</a></li>
<li class="toctree-l3"><a class="reference internal" href="KerasModel.html">Keras Model tutorial</a></li>
<li class="toctree-l3"><a class="reference internal" href="TfModel.html">Tensorflow Model tutorial</a></li>
<li class="toctree-l3"><a class="reference internal" href="PytorchModel.html">Pytorch Model tutorial</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">Matconvnet Model tutorial</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#charging-a-model">Charging a model</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="MatlabModel.html">Matlab Model tutorial</a></li>
<li class="toctree-l3"><a class="reference internal" href="OnnxModel.html">Onnx Model tutorial</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../examples.html#jupyter-notebooks">Jupyter Notebooks</a></li>
</ul>
</li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">OpenDenoising</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../examples.html">Examples</a> &raquo;</li>
        
      <li>Matconvnet Model tutorial</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/Examples/MatconvnetModel.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  
<style>
/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast,
.nboutput.nblast {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast + .nbinput {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}

/* Fix math alignment, see https://github.com/rtfd/sphinx_rtd_theme/pull/686 */
.math {
    text-align: unset;
}
</style>
<div class="section" id="matconvnet-model-tutorial">
<h1>Matconvnet Model tutorial<a class="headerlink" href="#matconvnet-model-tutorial" title="Permalink to this headline">¶</a></h1>
<p>This tutorial is a part of Model module guide. Here, we explore how you
can use the Matconvnet wrapper to use your Matconvnet deep learning
models in the benchmark.</p>
<p>First, being on the project’s root, you need to import the necessary modules,</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Python packages</span>
<span class="kn">import</span> <span class="nn">gc</span>
<span class="kn">import</span> <span class="nn">matlab.engine</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="kn">from</span> <span class="nn">functools</span> <span class="k">import</span> <span class="n">partial</span>
<span class="kn">from</span> <span class="nn">OpenDenoising</span> <span class="k">import</span> <span class="n">data</span>
<span class="kn">from</span> <span class="nn">OpenDenoising</span> <span class="k">import</span> <span class="n">model</span>
<span class="kn">from</span> <span class="nn">OpenDenoising</span> <span class="k">import</span> <span class="n">evaluation</span>

<span class="n">eng</span> <span class="o">=</span> <span class="n">matlab</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">start_matlab</span><span class="p">()</span>
</pre></div>
</div>
<p>The following function will be used throughout this tutorial to display denoising results,</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">display_results</span><span class="p">(</span><span class="n">clean_imgs</span><span class="p">,</span> <span class="n">noisy_imgs</span><span class="p">,</span> <span class="n">rest_images</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Display denoising results.&quot;&quot;&quot;</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">15</span><span class="p">))</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;Denoising results using </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">clean_imgs</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;gray&quot;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Ground-Truth&quot;</span><span class="p">)</span>

        <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">noisy_imgs</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;gray&quot;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Noised Image&quot;</span><span class="p">)</span>

        <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">rest_imgs</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;gray&quot;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Restored Images&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Moreover, you may download the data we will use by using the following function,</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">data</span><span class="o">.</span><span class="n">download_BSDS_grayscale</span><span class="p">(</span><span class="n">output_dir</span><span class="o">=</span><span class="s2">&quot;./tmp/BSDS500/&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>The models will be evaluated using the BSDS dataset,</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Validation images generator</span>
<span class="n">valid_generator</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">DatasetFactory</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="s2">&quot;./tmp/BSDS500/Valid&quot;</span><span class="p">,</span>
                                             <span class="n">batch_size</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
                                             <span class="n">n_channels</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                             <span class="n">noise_config</span><span class="o">=</span><span class="p">{</span><span class="n">data</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">gaussian_noise</span><span class="p">:</span> <span class="p">[</span><span class="mi">25</span><span class="p">]},</span>
                                             <span class="n">name</span><span class="o">=</span><span class="s2">&quot;BSDS_Valid&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Matconvnet models are Deep Learning models based on the <a class="reference external" href="http://www.vlfeat.org/matconvnet/">Matconvnet
toolbox</a> for Matlab. These models
may be used in Python through Matlab’s Python engine, which enables the
users to run matlab code inside Python.</p>
<p>Although possible to run, the implementation of Matlab’s numerical types
is not always straightforward, hence, every arithimetic calculation is
done through Matlab functions. Here we go through two examples of Deep
Neural networks implemented using Matconvnet’s Simple and DAGNN classes,
<a class="reference external" href="https://github.com/cszn/DnCNN">DnCNN</a> and
<a class="reference external" href="https://github.com/lpj0/MWCNN">MWCNN</a>.</p>
<p><strong>Remark</strong> Matconvnet model’s are only available for evaluation.</p>
<div class="section" id="charging-a-model">
<h2>Charging a model<a class="headerlink" href="#charging-a-model" title="Permalink to this headline">¶</a></h2>
<p>Following <a class="reference external" href="http://www.vlfeat.org/matconvnet/matconvnet-manual.pdf">Matconvnet’s
tutorial</a>,
the Toolbox has two main wrappers,</p>
<ul class="simple">
<li><p>SimpleNN, a wrapper suitable for networks consisting of linear chains
of computationalblocks. It is largely implemented by
thevl_simplennfunction (evaluation of the CNN and ofits derivatives),
with a few other support functions such asvl_simplenn_move(moving
theCNN between CPU and GPU) andvl_simplenn_display(obtain and/or
print informationabout the CNN).</p></li>
<li><p>DagNN wrapper, which is more complex than SimpleNN as it has to
support arbitrary graphtopologies. Its design is object oriented,
with one class implementing each layer type.</p></li>
</ul>
<p>In order to use your Matlab code along with our Benchmark, you will need
to implement a “denoise” function, which is responsible for doing three
main tasks,</p>
<ol class="arabic simple">
<li><p>Load the network architecture. This function reads a .mat file which
contains the network architecture and its weights.</p></li>
<li><p>Move the network and the noisy input array to GPU (if GPU is
enabled).</p></li>
<li><p>Perform denoising, by calling either <strong>vl_simplenn</strong> (simplenn) or
<strong>net.eval</strong> (dagnn).</p></li>
<li><p>Pass the restored image array back to CPU, if GPU is enabled.</p></li>
</ol>
<p>The “denoise” function should have “denoise” in its name (i.e.
“DnCNN_denoise”), and should agree with the following convention:</p>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="k">function</span><span class="w"> </span>image_restored <span class="p">=</span><span class="w"> </span><span class="nf">mynet_denoise</span><span class="p">(</span>net_path, image, useGPU<span class="p">)</span><span class="w"></span>
<span class="c">% Loading net</span>
<span class="c">% Move net + arrays to GPU</span>
<span class="c">% perform denoising</span>
<span class="c">% Move result to CPU</span>
<span class="k">end</span>
</pre></div>
</div>
<div class="section" id="simplenn">
<h3>SimpleNN<a class="headerlink" href="#simplenn" title="Permalink to this headline">¶</a></h3>
<p>The SimpleNN wrapper class is well suited for linear chains of neural
network layers. In order to construct the neural network object, you
need to specify the path to a “.mat” file containing a pre-trained
SimpleNN network. In our example, we consider a SimpleNN-based DnCNN
taken from the <a class="reference external" href="https://github.com/cszn/DnCNN">Github Repository</a> of
DnCNN’s paper. The model was trained to denoise images with
<span class="math notranslate nohighlight">\(\sigma=25\)</span> gaussian noise. In order to use the model, we propose
the following Matlab function,</p>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="k">function</span><span class="w"> </span>[image_restored] <span class="p">=</span><span class="w"> </span><span class="nf">DnCNN_denoise</span><span class="p">(</span>net_path, image, useGPU<span class="p">)</span><span class="w"></span>
<span class="c">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
<span class="c">% Given an image array, simplenn_denoise performs image denoising by     %</span>
<span class="c">% loading a deep neural network architecture located on &#39;net_path&#39;.      %</span>
<span class="c">% Params:                                                                %</span>
<span class="c">%   1) net_path: path to .m file containing the model.                   %</span>
<span class="c">%   2) image: 2d float array containing the image                        %</span>
<span class="c">%   3) useGPU: boolean defining if it will use GPU or not.               %</span>
<span class="c">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>

<span class="c">%% Load Network architecture</span>
<span class="n">net_obj</span> <span class="p">=</span> <span class="n">load</span><span class="p">(</span><span class="n">net_path</span><span class="p">);</span>               <span class="c">% Loads the network into the workspace</span>
<span class="n">net</span> <span class="p">=</span> <span class="n">net_obj</span><span class="p">.</span><span class="n">net</span><span class="p">;</span>                      <span class="c">% Gets the network from the network object in workspace</span>
<span class="n">net</span> <span class="p">=</span> <span class="n">vl_simplenn_tidy</span><span class="p">(</span><span class="n">net</span><span class="p">);</span>            <span class="c">% Fixes the network in case of version incompatibilities</span>

<span class="c">%% Move net to GPU</span>
<span class="k">if</span> <span class="n">useGPU</span> <span class="o">==</span> <span class="mi">1</span>
    <span class="n">net</span> <span class="p">=</span> <span class="n">vl_simplenn_move</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="s">&#39;gpu&#39;</span><span class="p">);</span> <span class="c">% Pass net to GPU</span>
    <span class="n">image</span> <span class="p">=</span> <span class="n">gpuArray</span><span class="p">(</span><span class="n">image</span><span class="p">);</span>            <span class="c">% Pass image to GPU</span>
<span class="k">end</span>

<span class="c">%% Perform denoising</span>
<span class="n">res</span> <span class="p">=</span> <span class="n">vl_simplenn</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="p">[],</span> <span class="p">[],</span> <span class="c">...         % vl_simplenn is the function used for to evaluate the network</span>
                  <span class="s">&#39;conserveMemory&#39;</span><span class="p">,</span> <span class="n">true</span><span class="p">,</span> <span class="c">...     % on the input &#39;image&#39;. &#39;conserveMemory&#39; parameter deletes all</span>
                  <span class="s">&#39;mode&#39;</span><span class="p">,</span> <span class="s">&#39;test&#39;</span><span class="p">);</span>                <span class="c">% intermediate responses. &#39;mode&#39; sets BatchNorm to test mode.</span>
<span class="n">image_restored</span> <span class="p">=</span> <span class="n">res</span><span class="p">(</span><span class="k">end</span><span class="p">).</span><span class="n">x</span><span class="p">;</span>                      <span class="c">% Gets the output of last layer.</span>

<span class="c">%% Move result to CPU</span>
<span class="k">if</span> <span class="n">useGPU</span> <span class="o">==</span> <span class="mi">1</span>
    <span class="n">image</span> <span class="p">=</span> <span class="n">gather</span><span class="p">(</span><span class="n">image</span><span class="p">);</span>                        <span class="c">% Gets image array from GPU.</span>
    <span class="n">image_restored</span> <span class="p">=</span> <span class="n">gather</span><span class="p">(</span><span class="n">image_restored</span><span class="p">);</span>      <span class="c">% Gets output array from GPU.</span>
<span class="k">end</span>

<span class="n">image_restored</span> <span class="p">=</span> <span class="n">single</span><span class="p">(</span><span class="n">image</span> <span class="o">-</span> <span class="n">image_restored</span><span class="p">);</span>  <span class="c">% In DnCNN, the network is used to predict the noise rather</span>
                                                  <span class="c">% than the image itself.</span>

<span class="k">end</span>
</pre></div>
</div>
<p>Considering such function, which needs to be defined in the same folder
as the model weight + architecture “.mat” file, you only need to pass
the path to the “.mat” file. Being so, consider the files on
“./Additional Files/Matconvnet Models/”,</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model_path</span> <span class="o">=</span> <span class="s2">&quot;/home/efernand/repos/Summer_Internship_2019/Code/examples&quot;</span> \
             <span class="s2">&quot;/Jupyter Notebooks/Additional Files/Matconvnet Models/simplenn/dncnn.mat&quot;</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">matconvnet_ex1</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">MatconvnetModel</span><span class="p">(</span><span class="n">model_name</span><span class="o">=</span><span class="s2">&quot;DnCNN&quot;</span><span class="p">)</span>
<span class="n">matconvnet_ex1</span><span class="o">.</span><span class="n">charge_model</span><span class="p">(</span><span class="n">model_path</span><span class="o">=</span><span class="n">model_path</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Get batch from valid_generator</span>
<span class="n">noisy_imgs</span><span class="p">,</span> <span class="n">clean_imgs</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">valid_generator</span><span class="p">)</span>
<span class="c1"># Performs inference on noisy images</span>
<span class="n">rest_imgs</span> <span class="o">=</span> <span class="n">matconvnet_ex1</span><span class="p">(</span><span class="n">noisy_imgs</span><span class="p">)</span>
<span class="c1"># Display results</span>
<span class="n">display_results</span><span class="p">(</span><span class="n">clean_imgs</span><span class="p">,</span> <span class="n">noisy_imgs</span><span class="p">,</span> <span class="n">rest_imgs</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">matconvnet_ex1</span><span class="p">))</span>
</pre></div>
</div>
<img alt="../_images/matconvnet_output_14_0.png" src="../_images/matconvnet_output_14_0.png" />
<div class="section" id="dagnn">
<h4>DAGNN<a class="headerlink" href="#dagnn" title="Permalink to this headline">¶</a></h4>
<p>DAGNN networks represents a wrapper for richer kinds of networks. For
our DAGNN network, we take <a class="reference external" href="https://github.com/lpj0/MWCNN">MWCNN</a> as
example, which rely on custom DWT (Discrete Wavelet Transform)/
IDWT(Inverse Discrete Wavelet Transform) layers to compute its output.</p>
<p>The process to compute the network’s output is the same, except from a
few syntax changes while loading the model, as follows,</p>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="k">function</span><span class="w"> </span>[image_restored] <span class="p">=</span><span class="w"> </span><span class="nf">MWCNN_denoise</span><span class="p">(</span>net_path, image, useGPU<span class="p">)</span><span class="w"></span>
<span class="c">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
<span class="c">% Given an image array, mwcnn performs image denoising by loading        %</span>
<span class="c">% a deep neural network architecture located on &#39;net_path&#39;.              %</span>
<span class="c">% Params:                                                                %</span>
<span class="c">%   1) net_path: path to .m file containing the model.                   %</span>
<span class="c">%   2) image: 2d float array containing the image                        %</span>
<span class="c">%   3) useGPU: boolean defining if it will use GPU or not.               %</span>
<span class="c">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>

<span class="c">%% Load Network architecture</span>
<span class="n">net_obj</span> <span class="p">=</span> <span class="n">load</span><span class="p">(</span><span class="n">net_path</span><span class="p">);</span>                               <span class="c">% Loads network object into workspace</span>
<span class="n">net</span> <span class="p">=</span> <span class="n">net_obj</span><span class="p">.</span><span class="n">net</span><span class="p">;</span>                                      <span class="c">% Gets network from network object</span>
<span class="n">net</span> <span class="p">=</span> <span class="n">dagnn</span><span class="p">.</span><span class="n">DagNN</span><span class="p">.</span><span class="n">loadobj</span><span class="p">(</span><span class="n">net</span><span class="p">);</span>                         <span class="c">% Loads the network into the wrapper</span>
<span class="n">net</span><span class="p">.</span><span class="n">removeLayer</span><span class="p">(</span><span class="s">&#39;objective&#39;</span><span class="p">);</span>                           <span class="c">% Remove objective layer (only needed for training)</span>
<span class="n">out_idx</span> <span class="p">=</span> <span class="n">net</span><span class="p">.</span><span class="n">getVarIndex</span><span class="p">(</span><span class="s">&#39;prediction&#39;</span><span class="p">);</span>                <span class="c">% Get prediction layer</span>
<span class="n">net</span><span class="p">.</span><span class="n">vars</span><span class="p">(</span><span class="n">net</span><span class="p">.</span><span class="n">getVarIndex</span><span class="p">(</span><span class="s">&#39;prediction&#39;</span><span class="p">)).</span><span class="n">precious</span> <span class="p">=</span> <span class="mi">1</span><span class="p">;</span>   <span class="c">% Fix network variable values.</span>
<span class="n">net</span><span class="p">.</span><span class="n">mode</span> <span class="p">=</span> <span class="s">&#39;test&#39;</span><span class="p">;</span>                                      <span class="c">% Set network to test model.</span>

<span class="c">%% Preprocess image</span>
<span class="c">% Scale images between -2 and +2.</span>
<span class="c">% OBS: needed only for MWCNN.</span>
<span class="n">input</span> <span class="p">=</span> <span class="n">image</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">-</span> <span class="mi">2</span><span class="p">;</span>

<span class="c">%% Move net to GPU</span>
<span class="k">if</span> <span class="n">useGPU</span> <span class="o">==</span> <span class="mi">1</span>
    <span class="n">net</span><span class="p">.</span><span class="n">move</span><span class="p">(</span><span class="s">&#39;gpu&#39;</span><span class="p">);</span>    <span class="c">% Pass net to GPU</span>
    <span class="n">input</span> <span class="p">=</span> <span class="n">gpuArray</span><span class="p">(</span><span class="n">input</span><span class="p">);</span>  <span class="c">% Pass image to GPU</span>
<span class="k">end</span>

<span class="c">%% Computes output</span>
<span class="n">net</span><span class="p">.</span><span class="n">eval</span><span class="p">({</span><span class="s">&#39;input&#39;</span><span class="p">,</span> <span class="n">input</span><span class="p">});</span>
<span class="n">image_restored</span> <span class="p">=</span> <span class="n">gather</span><span class="p">(</span><span class="c">...</span>
    <span class="nb">squeeze</span><span class="p">(</span><span class="c">...</span>
        <span class="n">gather</span><span class="p">(</span><span class="c">...</span>
            <span class="n">net</span><span class="p">.</span><span class="n">vars</span><span class="p">(</span><span class="n">out_idx</span><span class="p">).</span><span class="n">value</span> <span class="o">+</span> <span class="mi">2</span> <span class="c">...</span>
        <span class="p">)</span> <span class="o">/</span> <span class="mi">4</span> <span class="c">...</span>
    <span class="p">)</span><span class="c">...</span>
<span class="p">);</span>

<span class="k">end</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model_path</span> <span class="o">=</span> <span class="s2">&quot;/home/efernand/repos/Summer_Internship_2019/Code/examples&quot;</span> \
             <span class="s2">&quot;/Jupyter Notebooks/Additional Files/Matconvnet Models/dagnn/mwcnn.mat&quot;</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">matconvnet_ex2</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">MatconvnetModel</span><span class="p">(</span><span class="n">model_name</span><span class="o">=</span><span class="s2">&quot;mwcnn&quot;</span><span class="p">)</span>
<span class="n">matconvnet_ex2</span><span class="o">.</span><span class="n">charge_model</span><span class="p">(</span><span class="n">model_path</span><span class="o">=</span><span class="n">model_path</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Get batch from valid_generator</span>
<span class="n">noisy_imgs</span><span class="p">,</span> <span class="n">clean_imgs</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">valid_generator</span><span class="p">)</span>
<span class="c1"># Performs inference on noisy images</span>
<span class="n">rest_imgs</span> <span class="o">=</span> <span class="n">matconvnet_ex2</span><span class="p">(</span><span class="n">noisy_imgs</span><span class="p">)</span>
<span class="c1"># Display results</span>
<span class="n">display_results</span><span class="p">(</span><span class="n">clean_imgs</span><span class="p">,</span> <span class="n">noisy_imgs</span><span class="p">,</span> <span class="n">rest_imgs</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">matconvnet_ex2</span><span class="p">))</span>
</pre></div>
</div>
<img alt="../_images/matconvnet_output_18_0.png" src="../_images/matconvnet_output_18_0.png" />
</div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="MatlabModel.html" class="btn btn-neutral float-right" title="Matlab Model tutorial" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="PytorchModel.html" class="btn btn-neutral float-left" title="Pytorch Model tutorial" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, Eduardo Montesuma, Florian Lemarchand

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>