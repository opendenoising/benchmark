

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Filtering Model tutorial &mdash; OpenDenoising 0.1 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/underscore.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
        <script type="text/javascript" src="../_static/language_data.js"></script>
        <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
        <script type="text/x-mathjax-config">MathJax.Hub.Config({"tex2jax": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true, "ignoreClass": "document", "processClass": "math|output_area"}})</script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Keras Model tutorial" href="KerasModel.html" />
    <link rel="prev" title="Example: creating datasets" href="DataTutorial.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> OpenDenoising
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../installation.html">Installation guide.</a></li>
<li class="toctree-l1"><a class="reference internal" href="../benchmark_api_doc.html">Benchmark API</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../examples.html">Examples</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../examples.html#basic-examples">Basic Examples</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../examples.html#in-depth-tutorials">In-depth Tutorials</a><ul class="current">
<li class="toctree-l3 current"><a class="current reference internal" href="#">Filtering Model tutorial</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#using-a-python-based-function-for-image-denoising">Using a Python-based function for Image Denoising.</a></li>
<li class="toctree-l4"><a class="reference internal" href="#using-a-matlab-based-function-for-image-denoising">Using a Matlab-based function for Image Denoising.</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="KerasModel.html">Keras Model tutorial</a></li>
<li class="toctree-l3"><a class="reference internal" href="TfModel.html">Tensorflow Model tutorial</a></li>
<li class="toctree-l3"><a class="reference internal" href="PytorchModel.html">Pytorch Model tutorial</a></li>
<li class="toctree-l3"><a class="reference internal" href="MatconvnetModel.html">Matconvnet Model tutorial</a></li>
<li class="toctree-l3"><a class="reference internal" href="MatlabModel.html">Matlab Model tutorial</a></li>
<li class="toctree-l3"><a class="reference internal" href="OnnxModel.html">Onnx Model tutorial</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../examples.html#jupyter-notebooks">Jupyter Notebooks</a></li>
</ul>
</li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">OpenDenoising</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../examples.html">Examples</a> &raquo;</li>
        
      <li>Filtering Model tutorial</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/Examples/FilteringModel.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  
<style>
/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast,
.nboutput.nblast {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast + .nbinput {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}

/* Fix math alignment, see https://github.com/rtfd/sphinx_rtd_theme/pull/686 */
.math {
    text-align: unset;
}
</style>
<div class="section" id="filtering-model-tutorial">
<h1>Filtering Model tutorial<a class="headerlink" href="#filtering-model-tutorial" title="Permalink to this headline">¶</a></h1>
<p>This tutorial is a part of Model module guide. Here, we explore how you
can use the FilteringModel wrapper to use your Python or Matlab
filtering functions in the benchmark.</p>
<p>First, being on the project’s root, you need to import the necessary modules,</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matlab.engine</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>

<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>
<span class="kn">from</span> <span class="nn">OpenDenoising</span> <span class="kn">import</span> <span class="n">data</span>
<span class="kn">from</span> <span class="nn">OpenDenoising</span> <span class="kn">import</span> <span class="n">model</span>

<span class="n">eng</span> <span class="o">=</span> <span class="n">matlab</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">start_matlab</span><span class="p">()</span>
</pre></div>
</div>
<p>The following function will be used throughout this tutorial to display denoising results,</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">display_results</span><span class="p">(</span><span class="n">clean_imgs</span><span class="p">,</span> <span class="n">noisy_imgs</span><span class="p">,</span> <span class="n">rest_images</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Display denoising results.&quot;&quot;&quot;</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">15</span><span class="p">))</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;Denoising results using {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">clean_imgs</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;gray&quot;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Ground-Truth&quot;</span><span class="p">)</span>

        <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">noisy_imgs</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;gray&quot;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Noised Image&quot;</span><span class="p">)</span>

        <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">rest_imgs</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;gray&quot;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Restored Images&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Moreover, you may download the data we will use by using the following function,</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">data</span><span class="o">.</span><span class="n">download_BSDS_grayscale</span><span class="p">(</span><span class="n">output_dir</span><span class="o">=</span><span class="s2">&quot;./tmp/BSDS500/&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>The models will be evaluated using the BSDS dataset,</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Validation images generator</span>
<span class="n">valid_generator</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">DatasetFactory</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="s2">&quot;./tmp/BSDS500/Valid&quot;</span><span class="p">,</span>
                                             <span class="n">batch_size</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
                                             <span class="n">n_channels</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                             <span class="n">noise_config</span><span class="o">=</span><span class="p">{</span><span class="n">data</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">gaussian_noise</span><span class="p">:</span> <span class="p">[</span><span class="mi">25</span><span class="p">]},</span>
                                             <span class="n">name</span><span class="o">=</span><span class="s2">&quot;BSDS_Valid&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>To define a filtering model, you need either a Python or Matlab function
that performs the denoising.</p>
<div class="section" id="using-a-python-based-function-for-image-denoising">
<h2>Using a Python-based function for Image Denoising.<a class="headerlink" href="#using-a-python-based-function-for-image-denoising" title="Permalink to this headline">¶</a></h2>
<p>Python-based functions should agree with the following convention:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">my_filter</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">optional_arguments</span><span class="p">):</span>
    <span class="c1"># Perform the filter algorithm</span>
    <span class="k">return</span> <span class="n">restored_image</span>
</pre></div>
</div>
<p>where image is a 4D numpy ndarray, and restored_image is a 4D numpy
ndarray with same shape as image. As an example, consider the
median_filter implemented on model.filtering,</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">median_filter</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">filter_size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">stride</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)):</span>
    <span class="sd">&quot;&quot;&quot;Naive implementation of median filter using numpy.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    image : :class:`numpy.ndarray`</span>
<span class="sd">        4D batch of noised images. It has shape: (batch_size, height, width, channels).</span>
<span class="sd">    filter_size : list</span>
<span class="sd">        2D list containing the size of filter&#39;s kernel.</span>
<span class="sd">    stride : list</span>
<span class="sd">        2D list containing the horizontal and vertical strides.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    output : :class:`numpy.ndarray`</span>
<span class="sd">        4D batch of denoised images. It has shape: (batch_size, height, width, channels).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">image</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">filter_size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">//</span> <span class="mi">2</span>
    <span class="n">sh</span><span class="p">,</span> <span class="n">sw</span> <span class="o">=</span> <span class="n">stride</span>

    <span class="n">_image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">pad_width</span><span class="o">=</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">p</span><span class="p">),</span> <span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">p</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)),</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;constant&quot;</span><span class="p">)</span>
    <span class="n">N</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="n">_image</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">h</span> <span class="o">-</span> <span class="n">p</span><span class="p">,</span> <span class="n">sh</span><span class="p">):</span>
        <span class="c1"># Loops over horizontal axis</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">w</span> <span class="o">-</span> <span class="n">p</span><span class="p">,</span> <span class="n">sw</span><span class="p">):</span>
            <span class="c1"># Loops over vertical axis</span>
            <span class="n">window</span> <span class="o">=</span> <span class="n">_image</span><span class="p">[:,</span> <span class="n">i</span> <span class="o">-</span> <span class="n">p</span><span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="n">p</span><span class="p">,</span> <span class="n">j</span> <span class="o">-</span> <span class="n">p</span><span class="p">:</span> <span class="n">j</span> <span class="o">+</span> <span class="n">p</span><span class="p">,</span> <span class="p">:]</span>
            <span class="n">output</span><span class="p">[:,</span> <span class="n">i</span> <span class="o">-</span> <span class="n">p</span><span class="p">,</span> <span class="n">j</span> <span class="o">-</span> <span class="n">p</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">window</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">output</span>
</pre></div>
</div>
<p>To charge the model in a Filtering Model, you can use,</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">filt1</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">FilteringModel</span><span class="p">(</span><span class="n">model_name</span><span class="o">=</span><span class="s2">&quot;Median_filter&quot;</span><span class="p">)</span>
<span class="c1"># Note: optinal arguments may be passed to charge_model via **kwargs</span>
<span class="n">filt1</span><span class="o">.</span><span class="n">charge_model</span><span class="p">(</span><span class="n">model_function</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">filtering</span><span class="o">.</span><span class="n">median_filter</span><span class="p">,</span> <span class="n">filter_size</span><span class="o">=</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">7</span><span class="p">),</span> <span class="n">stride</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="section" id="using-a-matlab-based-function-for-image-denoising">
<h2>Using a Matlab-based function for Image Denoising.<a class="headerlink" href="#using-a-matlab-based-function-for-image-denoising" title="Permalink to this headline">¶</a></h2>
<p>You can also use Matlab functions to perform image denoising. To do so,
you need to wrap your Matlab function with a Python function. As an
example, consider the <a class="reference external" href="http://www.cs.tut.fi/~foi/GCF-BM3D/">BM3D matlab’s
implementation</a>. You can
download the author’s code and add it to Matlab’s “pathdef.m” file.
As an example of function wrapping matlab’s code, consider the
following:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">BM3D</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mf">25.0</span><span class="p">,</span> <span class="n">profile</span><span class="o">=</span><span class="s2">&quot;np&quot;</span><span class="p">,</span> <span class="n">channels_first</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This function wraps MATLAB&#39;s BM3D implementation, available on matlab_libs/BM3Dlib. The original code is</span>
<span class="sd">    available to the public through the author&#39;s page, on http://www.cs.tut.fi/~foi/GCF-BM3D/</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    z : :class:`numpy.ndarray`</span>
<span class="sd">        4D batch of noised images. It has shape: (batch_size, height, width, channels).</span>
<span class="sd">    sigma : float</span>
<span class="sd">        Level of gaussian noise.</span>
<span class="sd">    profile : str</span>
<span class="sd">        One between {&#39;np&#39;, &#39;lc&#39;, &#39;high&#39;, &#39;vn&#39;, &#39;vn_old&#39;}. Algorithm&#39;s profile.</span>

<span class="sd">        Available for grayscale:</span>

<span class="sd">        * &#39;np&#39;: Normal profile.</span>
<span class="sd">        * &#39;lc&#39;: Fast profile.</span>
<span class="sd">        * &#39;high&#39;: High quality profile.</span>
<span class="sd">        * &#39;vn&#39;: High noise profile (sigma &gt; 40.0)</span>
<span class="sd">        * &#39;vn_old&#39;: old &#39;vn&#39; profile. Yields inferior results than &#39;vn&#39;.</span>

<span class="sd">        Available for RGB:</span>

<span class="sd">        * &#39;np&#39;: Normal profile.</span>
<span class="sd">        * &#39;lc&#39;: Fast profile.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    y_est : :class:`numpy.ndarray`</span>
<span class="sd">        4D batch of denoised images. It has shape: (batch_size, height, width, channels).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_z</span> <span class="o">=</span> <span class="n">z</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">rgb</span> <span class="o">=</span> <span class="bp">True</span> <span class="k">if</span> <span class="n">_z</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">3</span> <span class="k">else</span> <span class="bp">False</span>
    <span class="k">if</span> <span class="n">rgb</span><span class="p">:</span>
        <span class="k">assert</span> <span class="p">(</span><span class="n">profile</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;np&quot;</span><span class="p">,</span> <span class="s2">&quot;lc&quot;</span><span class="p">,</span> <span class="s2">&quot;high&quot;</span><span class="p">,</span> <span class="s2">&quot;vn&quot;</span><span class="p">,</span> <span class="s2">&quot;vn_old&quot;</span><span class="p">]),</span> <span class="s2">&quot;Expected profile to be &#39;np&#39;, &#39;lc&#39;, &#39;high&#39;, &#39;vn&#39; &quot;</span> \
                                                                  <span class="s2">&quot;or &#39;vn_old&#39; but got {}.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">profile</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">assert</span> <span class="p">(</span><span class="n">profile</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;np&quot;</span><span class="p">,</span> <span class="s2">&quot;lc&quot;</span><span class="p">]),</span> <span class="s2">&quot;Expected profile to be &#39;np&#39;, &#39;lc&#39; bug got {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">profile</span><span class="p">)</span>

    <span class="c1"># Convert input arrays to matlab</span>
    <span class="n">m_sigma</span> <span class="o">=</span> <span class="n">matlab</span><span class="o">.</span><span class="n">double</span><span class="p">([</span><span class="n">sigma</span><span class="p">])</span>
    <span class="n">m_show</span> <span class="o">=</span> <span class="n">matlab</span><span class="o">.</span><span class="n">int64</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span>

    <span class="c1"># Call BM3D function on matlab</span>
    <span class="n">y_est</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">_z</span><span class="p">)):</span>
        <span class="n">m_z</span> <span class="o">=</span> <span class="n">matlab</span><span class="o">.</span><span class="n">double</span><span class="p">(</span><span class="n">_z</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:]</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">rgb</span><span class="p">:</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">y_est</span> <span class="o">=</span> <span class="n">eng</span><span class="o">.</span><span class="n">CBM3D</span><span class="p">(</span><span class="n">m_z</span><span class="p">,</span> <span class="n">m_z</span><span class="p">,</span> <span class="n">m_sigma</span><span class="p">,</span> <span class="n">profile</span><span class="p">,</span> <span class="n">m_show</span><span class="p">,</span> <span class="n">nargout</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">eng</span><span class="o">.</span><span class="n">BM3D</span><span class="p">(</span><span class="n">m_z</span><span class="p">,</span> <span class="n">m_z</span><span class="p">,</span> <span class="n">m_sigma</span><span class="p">,</span> <span class="n">profile</span><span class="p">,</span> <span class="n">m_show</span><span class="p">,</span> <span class="n">nargout</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">y_est</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">y</span><span class="p">))</span>

    <span class="n">y_est</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">y_est</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">z</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">y_est</span>
</pre></div>
</div>
<p>Here, we make a few remarks,</p>
<ul class="simple">
<li><p>You need your engine to be defined in order to call the Matlab
function.</p></li>
<li><p>Inside the Python’s matlab module, you have a series of classes
making the bridge between Python and Matlab variables. Moreover,
Python does not handle so well operations between these classes (for
instance, the addition between two matlab.double variables). A way to
get around this, is to do all operations inside of Matlab’s
functions. Therefore, your Python wrapper function should prepare the
arguments to be passed to your Matlab function, followed by a call
“eng.my_matlab_function”.</p></li>
<li><p>If your matlab function returns more than one argument, you need to
specify the “nargout” parameter (even if it is not present in your
Matlab code).</p></li>
<li><p>After Matlab done its computation, it outputs “Matlab arrays”. These
can be converted into numpy arrays by calling “numpy.asarray”
function.</p></li>
</ul>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">filt2</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">FilteringModel</span><span class="p">(</span><span class="n">model_name</span><span class="o">=</span><span class="s2">&quot;BM3D_filter&quot;</span><span class="p">)</span>
<span class="n">filt2</span><span class="o">.</span><span class="n">charge_model</span><span class="p">(</span><span class="n">model_function</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">filtering</span><span class="o">.</span><span class="n">BM3D</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mf">25.0</span><span class="p">,</span> <span class="n">profile</span><span class="o">=</span><span class="s2">&quot;np&quot;</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Get batch from generator</span>
<span class="n">noisy_imgs</span><span class="p">,</span> <span class="n">clean_imgs</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">valid_generator</span><span class="p">)</span>
<span class="c1"># Performs inference on noisy images</span>
<span class="n">rest_imgs</span> <span class="o">=</span> <span class="n">filt1</span><span class="p">(</span><span class="n">noisy_imgs</span><span class="p">)</span>
<span class="n">display_results</span><span class="p">(</span><span class="n">clean_imgs</span><span class="p">,</span> <span class="n">noisy_imgs</span><span class="p">,</span> <span class="n">rest_imgs</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">filt1</span><span class="p">))</span>
</pre></div>
</div>
<img alt="../_images/output_13_0.png" src="../_images/output_13_0.png" />
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Get batch from valid_generator</span>
<span class="n">noisy_imgs</span><span class="p">,</span> <span class="n">clean_imgs</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">valid_generator</span><span class="p">)</span>
<span class="c1"># Performs inference on noisy images</span>
<span class="n">rest_imgs</span> <span class="o">=</span> <span class="n">filt2</span><span class="p">(</span><span class="n">noisy_imgs</span><span class="p">)</span>
<span class="n">display_results</span><span class="p">(</span><span class="n">clean_imgs</span><span class="p">,</span> <span class="n">noisy_imgs</span><span class="p">,</span> <span class="n">rest_imgs</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">filt2</span><span class="p">))</span>
</pre></div>
</div>
<img alt="../_images/output_14_0.png" src="../_images/output_14_0.png" />
<div class="section" id="providing-your-own-matlab-functions">
<h3>Providing your own Matlab functions<a class="headerlink" href="#providing-your-own-matlab-functions" title="Permalink to this headline">¶</a></h3>
<p>Consider one more example of how you can include Matlab functions into
your FilteringModels. We define a script for a function called
“kernel_filter” in the folder “./Examples/Jupyter Notebooks/Additional
Files”. The Matlab function has the following implementation:</p>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="k">function</span><span class="w"> </span>y_est <span class="p">=</span><span class="w"> </span><span class="nf">kernel_filter</span><span class="p">(</span>z, kernel<span class="p">)</span><span class="w"></span>

<span class="n">k</span> <span class="p">=</span> <span class="nb">size</span><span class="p">(</span><span class="n">kernel</span><span class="p">);</span>
<span class="n">k</span> <span class="p">=</span> <span class="nb">floor</span><span class="p">(</span><span class="n">k</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>
<span class="nb">ndims</span> <span class="p">=</span> <span class="nb">length</span><span class="p">(</span><span class="nb">size</span><span class="p">(</span><span class="n">z</span><span class="p">));</span>
<span class="n">y_est</span> <span class="p">=</span> <span class="nb">zeros</span><span class="p">(</span><span class="nb">size</span><span class="p">(</span><span class="n">z</span><span class="p">));</span>

<span class="k">if</span> <span class="nb">ndims</span> <span class="o">==</span> <span class="mi">2</span>
    <span class="n">z_</span> <span class="p">=</span> <span class="n">padarray</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="n">k</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&#39;both&#39;</span><span class="p">);</span>
    <span class="p">[</span><span class="n">N</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">c</span><span class="p">]</span> <span class="p">=</span> <span class="nb">size</span><span class="p">(</span><span class="n">z_</span><span class="p">);</span>
    <span class="k">for</span> <span class="nb">i</span><span class="p">=</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="n">h</span>
        <span class="k">for</span> <span class="nb">j</span><span class="p">=</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="n">w</span>
            <span class="n">window</span> <span class="p">=</span> <span class="n">sum</span><span class="p">(</span><span class="n">z_</span><span class="p">(</span><span class="nb">i</span><span class="o">-</span><span class="n">k</span><span class="p">:</span><span class="nb">i</span><span class="o">+</span><span class="n">k</span><span class="p">,</span> <span class="nb">j</span><span class="o">-</span><span class="n">k</span><span class="p">:</span><span class="nb">j</span><span class="o">+</span><span class="n">k</span><span class="p">)</span> <span class="o">.*</span> <span class="n">kernel</span><span class="p">,</span> <span class="s">&#39;all&#39;</span><span class="p">);</span>
            <span class="n">y_est</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="nb">i</span> <span class="o">-</span> <span class="n">k</span><span class="p">,</span> <span class="nb">j</span> <span class="o">-</span> <span class="n">k</span><span class="p">)</span> <span class="p">=</span> <span class="n">window</span><span class="p">;</span>
        <span class="k">end</span>
    <span class="k">end</span>
<span class="k">else</span>
    <span class="n">z_</span> <span class="p">=</span> <span class="n">padarray</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&#39;both&#39;</span><span class="p">);</span>
    <span class="p">[</span><span class="n">N</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">c</span><span class="p">]</span> <span class="p">=</span> <span class="nb">size</span><span class="p">(</span><span class="n">z_</span><span class="p">);</span>
    <span class="n">kernel</span> <span class="p">=</span> <span class="nb">repmat</span><span class="p">(</span><span class="n">kernel</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">]);</span>
    <span class="k">for</span> <span class="nb">i</span><span class="p">=</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="n">h</span><span class="o">-</span><span class="n">k</span>
        <span class="k">for</span> <span class="nb">j</span><span class="p">=</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="n">w</span><span class="o">-</span><span class="n">k</span>
            <span class="n">window</span> <span class="p">=</span> <span class="n">sum</span><span class="p">(</span><span class="n">sum</span><span class="p">(</span><span class="n">z_</span><span class="p">(</span><span class="nb">i</span><span class="o">-</span><span class="n">k</span><span class="p">:</span><span class="nb">i</span><span class="o">+</span><span class="n">k</span><span class="p">,</span> <span class="nb">j</span><span class="o">-</span><span class="n">k</span><span class="p">:</span><span class="nb">j</span><span class="o">+</span><span class="n">k</span><span class="p">,</span> <span class="p">:)</span> <span class="o">.*</span> <span class="n">kernel</span><span class="p">));</span>
            <span class="n">y_est</span><span class="p">(</span><span class="nb">i</span> <span class="o">-</span> <span class="n">k</span><span class="p">,</span> <span class="nb">j</span> <span class="o">-</span> <span class="n">k</span><span class="p">,</span> <span class="p">:)</span> <span class="p">=</span> <span class="n">window</span><span class="p">;</span>
        <span class="k">end</span>
    <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>
<p>As we can see, this function denoises one single image at time, so the
4D-in 4D-out convention needs to be handled in the Python wrapper
function. Then, you can verify that the function is indeed on your
Matlab’s path by executing:</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">eng</span><span class="o">.</span><span class="n">addpath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="s2">&quot;./Additional Files/&quot;</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">eng</span><span class="o">.</span><span class="n">which</span><span class="p">(</span><span class="s2">&quot;kernel_filter&quot;</span><span class="p">))</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">efernand</span><span class="o">/</span><span class="n">repos</span><span class="o">/</span><span class="n">Summer_Internship_2019</span><span class="o">/</span><span class="n">Code</span><span class="o">/</span><span class="n">examples</span><span class="o">/</span><span class="n">Jupyter</span> <span class="n">Notebooks</span><span class="o">/</span><span class="n">Additional</span> <span class="n">Files</span><span class="o">/</span><span class="n">kernel_filter</span><span class="o">.</span><span class="n">m</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">kernel_filter_wrapper</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">kernel</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Naive implementation of spatial filtering with numpy.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    image : :class:`numpy.ndarray`</span>
<span class="sd">        4D batch of noised images. It has shape: (batch_size, height, width, channels).</span>
<span class="sd">    kernel : :class:`numpy.ndarray`</span>
<span class="sd">        2D filter to be convolved with each image in the batch.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    y_est : :class:`numpy.ndarray`</span>
<span class="sd">        4D batch of denoised images. It has shape: (batch_size, height, width, channels).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">m_kernel</span> <span class="o">=</span> <span class="n">matlab</span><span class="o">.</span><span class="n">double</span><span class="p">(</span><span class="n">kernel</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span> <span class="c1"># Converts Kernel to Matlab double class.</span>
    <span class="n">y_est</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># List of outputs</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">image</span><span class="p">)):</span>
        <span class="n">m_image</span> <span class="o">=</span> <span class="n">matlab</span><span class="o">.</span><span class="n">double</span><span class="p">(</span><span class="n">image</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span> <span class="c1"># Converts i-th image to Matlab double class.</span>
        <span class="c1"># Note: matlab.double class only accepts lists as inputs, so you need to call .tolist() in your numpy arrays.</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">eng</span><span class="o">.</span><span class="n">kernel_filter</span><span class="p">(</span><span class="n">m_image</span><span class="p">,</span> <span class="n">m_kernel</span><span class="p">)</span> <span class="c1"># Calls matlab &quot;kernel_filter&quot; with inputs m_image and m_kernel</span>
        <span class="n">y_est</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">y</span><span class="p">))</span> <span class="c1"># Appends Matlab&#39;s output as numpy array</span>
    <span class="n">y_est</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">y_est</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="c1"># Converts list of outputs into array.</span>
    <span class="k">return</span> <span class="n">y_est</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">kernel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">([</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">])</span> <span class="o">/</span> <span class="mi">25</span> <span class="c1"># Mean filter kernel</span>

<span class="n">filt3</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">FilteringModel</span><span class="p">(</span><span class="n">model_name</span><span class="o">=</span><span class="s2">&quot;kernel_filter&quot;</span><span class="p">)</span>
<span class="n">filt3</span><span class="o">.</span><span class="n">charge_model</span><span class="p">(</span><span class="n">model_function</span><span class="o">=</span><span class="n">kernel_filter_wrapper</span><span class="p">,</span> <span class="n">kernel</span><span class="o">=</span><span class="n">kernel</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Get batch from valid_generator</span>
<span class="n">noisy_imgs</span><span class="p">,</span> <span class="n">clean_imgs</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">valid_generator</span><span class="p">)</span>
<span class="c1"># Performs inference on noisy images</span>
<span class="n">rest_imgs</span> <span class="o">=</span> <span class="n">filt3</span><span class="p">(</span><span class="n">noisy_imgs</span><span class="p">)</span>
<span class="n">display_results</span><span class="p">(</span><span class="n">clean_imgs</span><span class="p">,</span> <span class="n">noisy_imgs</span><span class="p">,</span> <span class="n">rest_imgs</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">filt3</span><span class="p">))</span>
</pre></div>
</div>
<img alt="../_images/output_19_0.png" src="../_images/output_19_0.png" />
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="KerasModel.html" class="btn btn-neutral float-right" title="Keras Model tutorial" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="DataTutorial.html" class="btn btn-neutral float-left" title="Example: creating datasets" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, Eduardo Montesuma, Florian Lemarchand

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>