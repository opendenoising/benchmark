

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Keras Model tutorial &mdash; OpenDenoising 0.1 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/underscore.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
        <script type="text/javascript" src="../_static/language_data.js"></script>
        <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
        <script type="text/x-mathjax-config">MathJax.Hub.Config({"tex2jax": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true, "ignoreClass": "document", "processClass": "math|output_area"}})</script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Tensorflow Model tutorial" href="TfModel.html" />
    <link rel="prev" title="Filtering Model tutorial" href="FilteringModel.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> OpenDenoising
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../installation.html">Installation guide.</a></li>
<li class="toctree-l1"><a class="reference internal" href="../benchmark_api_doc.html">Benchmark API</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../examples.html">Examples</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../examples.html#basic-examples">Basic Examples</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../examples.html#in-depth-tutorials">In-depth Tutorials</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="FilteringModel.html">Filtering Model tutorial</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">Keras Model tutorial</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#charging-a-model">Charging a model</a></li>
<li class="toctree-l4"><a class="reference internal" href="#from-a-function">From a function</a></li>
<li class="toctree-l4"><a class="reference internal" href="#from-a-file">From a file</a></li>
<li class="toctree-l4"><a class="reference internal" href="#training-a-kerasmodel">Training a KerasModel</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="TfModel.html">Tensorflow Model tutorial</a></li>
<li class="toctree-l3"><a class="reference internal" href="PytorchModel.html">Pytorch Model tutorial</a></li>
<li class="toctree-l3"><a class="reference internal" href="MatconvnetModel.html">Matconvnet Model tutorial</a></li>
<li class="toctree-l3"><a class="reference internal" href="MatlabModel.html">Matlab Model tutorial</a></li>
<li class="toctree-l3"><a class="reference internal" href="OnnxModel.html">Onnx Model tutorial</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../examples.html#jupyter-notebooks">Jupyter Notebooks</a></li>
</ul>
</li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">OpenDenoising</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../examples.html">Examples</a> &raquo;</li>
        
      <li>Keras Model tutorial</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/Examples/KerasModel.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  
<style>
/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast,
.nboutput.nblast {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast + .nbinput {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}

/* Fix math alignment, see https://github.com/rtfd/sphinx_rtd_theme/pull/686 */
.math {
    text-align: unset;
}
</style>
<div class="section" id="keras-model-tutorial">
<h1>Keras Model tutorial<a class="headerlink" href="#keras-model-tutorial" title="Permalink to this headline">¶</a></h1>
<p>This tutorial is a part of Model module guide. Here, we explore how you
can use the FilteringModel wrapper to use your Python or Matlab
filtering functions in the benchmark.</p>
<p>First, being on the project’s root, you need to import the necessary modules,</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">gc</span>
<span class="kn">import</span> <span class="nn">keras</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">tensorflow</span> <span class="kn">as</span> <span class="nn">tf</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>

<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>
<span class="kn">from</span> <span class="nn">OpenDenoising</span> <span class="kn">import</span> <span class="n">data</span>
<span class="kn">from</span> <span class="nn">OpenDenoising</span> <span class="kn">import</span> <span class="n">model</span>
<span class="kn">from</span> <span class="nn">keras</span> <span class="kn">import</span> <span class="n">layers</span><span class="p">,</span> <span class="n">models</span>
<span class="kn">from</span> <span class="nn">OpenDenoising</span> <span class="kn">import</span> <span class="n">evaluation</span>

<span class="n">eng</span> <span class="o">=</span> <span class="n">matlab</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">start_matlab</span><span class="p">()</span>
</pre></div>
</div>
<p>The following function will be used throughout this tutorial to display denoising results,</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">display_results</span><span class="p">(</span><span class="n">clean_imgs</span><span class="p">,</span> <span class="n">noisy_imgs</span><span class="p">,</span> <span class="n">rest_images</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Display denoising results.&quot;&quot;&quot;</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">15</span><span class="p">))</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;Denoising results using {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">clean_imgs</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;gray&quot;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Ground-Truth&quot;</span><span class="p">)</span>

        <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">noisy_imgs</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;gray&quot;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Noised Image&quot;</span><span class="p">)</span>

        <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">rest_imgs</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;gray&quot;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Restored Images&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Moreover, you may download the data we will use by using the following function,</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">data</span><span class="o">.</span><span class="n">download_BSDS_grayscale</span><span class="p">(</span><span class="n">output_dir</span><span class="o">=</span><span class="s2">&quot;./tmp/BSDS500/&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>The models will be evaluated using the BSDS dataset,</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Training images generator</span>
<span class="n">train_generator</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">DatasetFactory</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="s2">&quot;./tmp/BSDS500/Train&quot;</span><span class="p">,</span>
                                             <span class="n">batch_size</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
                                             <span class="n">n_channels</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                             <span class="n">noise_config</span><span class="o">=</span><span class="p">{</span><span class="n">data</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">gaussian_noise</span><span class="p">:</span> <span class="p">[</span><span class="mi">25</span><span class="p">]},</span>
                                             <span class="n">preprocessing</span><span class="o">=</span><span class="p">[</span><span class="n">partial</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">gen_patches</span><span class="p">,</span> <span class="n">patch_size</span><span class="o">=</span><span class="mi">40</span><span class="p">),</span>
                                                            <span class="n">partial</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">dncnn_augmentation</span><span class="p">,</span> <span class="n">aug_times</span><span class="o">=</span><span class="mi">1</span><span class="p">)],</span>
                                             <span class="n">name</span><span class="o">=</span><span class="s2">&quot;BSDS_Train&quot;</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Validation images generator</span>
<span class="n">valid_generator</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">DatasetFactory</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="s2">&quot;./tmp/BSDS500/Valid&quot;</span><span class="p">,</span>
                                             <span class="n">batch_size</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
                                             <span class="n">n_channels</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                             <span class="n">noise_config</span><span class="o">=</span><span class="p">{</span><span class="n">data</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">gaussian_noise</span><span class="p">:</span> <span class="p">[</span><span class="mi">25</span><span class="p">]},</span>
                                             <span class="n">name</span><span class="o">=</span><span class="s2">&quot;BSDS_Valid&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>To execute multiple models that access the GPU, you need to allow Tensorflow/Keras to allocate memory only when
needed. This is done through,</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">config</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">ConfigProto</span><span class="p">()</span>
<span class="n">config</span><span class="o">.</span><span class="n">gpu_options</span><span class="o">.</span><span class="n">allow_growth</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">session</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">Session</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">)</span>
<span class="n">keras</span><span class="o">.</span><span class="n">backend</span><span class="o">.</span><span class="n">set_session</span><span class="p">(</span><span class="n">session</span><span class="p">)</span>
</pre></div>
</div>
<p>Keras offers two ways to construct a model, whether by explicitly
programming it using their API, or by using a file to load the
computational graph. Once you have constructed your model, you will have
at hand a “keras.models.Model” class instance.</p>
<p>Since the use of different frameworks is not the same, to force Keras
models to adequate their functionality to the Benchmark needs, we
provide the KerasModel class, that redefines some of the Keras API
functionalities.</p>
<div class="section" id="charging-a-model">
<h2>Charging a model<a class="headerlink" href="#charging-a-model" title="Permalink to this headline">¶</a></h2>
<p>The first step to build a KerasModel instance, is to effectively charge
a keras model (“keras.models.Model”) into the class. This is done
through the method “<strong>charge_model</strong>”. There are two ways to charge the
model into the wrapper class: by using a function, or by using a file.
These two cases are managed by the use of three parameters of the method
“<strong>charge_model</strong>”:</p>
<ul class="simple">
<li><p><strong>model_function</strong>: This argument receives a function object (with
__call__ method defined). The function object is responsable to
build the Keras model inside the class.</p></li>
<li><p><strong>model_path</strong>: This argument is a string containing the path to a
.hdf5 file (weights + architecture) or a .json/.yaml file
(architecture).</p></li>
<li><p><strong>model_weights</strong>: If you passed the model architecture through a
.json file, and you do have a .hdf5 containing weights only, you can
pass the path to the .hdf5 weight file using the “model_weights”
parameter.</p></li>
</ul>
</div>
<div class="section" id="from-a-function">
<h2>From a function<a class="headerlink" href="#from-a-function" title="Permalink to this headline">¶</a></h2>
<p>To charge a “keras.models.Model” into the wrapper class, you need to
explicitly program the Keras model. To do so, you should provide to the
method “<strong>charge_model</strong>” a function that returns an instance of
“keras.models.Model” class corresponding to your architecture. As an
example, consider the following implementation of <a class="reference external" href="https://arxiv.org/pdf/1608.03981.pdf">DnCNN
network</a>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">dncnn</span><span class="p">():</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">InputLayer</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">[</span><span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Conv2D</span><span class="p">(</span><span class="n">filters</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">strides</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Activation</span><span class="p">(</span><span class="s2">&quot;relu&quot;</span><span class="p">)(</span><span class="n">y</span><span class="p">)</span>

    <span class="c1"># Middle layers: Conv + ReLU + BN</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">16</span><span class="p">):</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Conv2D</span><span class="p">(</span><span class="n">filters</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">strides</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">,</span> <span class="n">use_bias</span><span class="o">=</span><span class="bp">False</span><span class="p">)(</span><span class="n">y</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">BatchNormalization</span><span class="p">(</span><span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">momentum</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">epsilon</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">)(</span><span class="n">y</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Activation</span><span class="p">(</span><span class="s2">&quot;relu&quot;</span><span class="p">)(</span><span class="n">y</span><span class="p">)</span>

    <span class="n">y</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Conv2D</span><span class="p">(</span><span class="n">filters</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">strides</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">use_bias</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">)(</span><span class="n">y</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Subtract</span><span class="p">()([</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">])</span>

    <span class="c1"># Keras model</span>
    <span class="k">return</span> <span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
</pre></div>
</div>
<p>additionally to this example, you should consider the following
convention to architecture functions:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">my_arch_func</span><span class="p">(</span><span class="n">optional</span> <span class="n">arguments</span><span class="p">):</span>
    <span class="c1"># Steps to build your Keras model</span>
    <span class="k">return</span> <span class="n">keras</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="n">outputs</span><span class="p">)</span>
</pre></div>
</div>
<p>In the following blocks of code, we show how we can charge the model
into a “KerasModel” wrapper class by using the “dncnn” function.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Creating the KerasModel instance</span>
<span class="n">kerasmodel_ex1</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">KerasModel</span><span class="p">(</span><span class="n">model_name</span><span class="o">=</span><span class="s2">&quot;Example1&quot;</span><span class="p">,</span> <span class="n">logdir</span><span class="o">=</span><span class="s2">&quot;../../logs/Keras&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;KerasModel </span><span class="si">{}</span><span class="s2"> created succesfully.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">kerasmodel_ex1</span><span class="p">))</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">KerasModel</span> <span class="n">Example1</span> <span class="n">created</span> <span class="n">succesfully</span><span class="o">.</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Defining the function to be charged</span>
<span class="k">def</span> <span class="nf">dncnn</span><span class="p">():</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Input</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Conv2D</span><span class="p">(</span><span class="n">filters</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">strides</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Activation</span><span class="p">(</span><span class="s2">&quot;relu&quot;</span><span class="p">)(</span><span class="n">y</span><span class="p">)</span>

    <span class="c1"># Middle layers: Conv + ReLU + BN</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">16</span><span class="p">):</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Conv2D</span><span class="p">(</span><span class="n">filters</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">strides</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">,</span> <span class="n">use_bias</span><span class="o">=</span><span class="kc">False</span><span class="p">)(</span><span class="n">y</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">BatchNormalization</span><span class="p">(</span><span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">momentum</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">epsilon</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">)(</span><span class="n">y</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Activation</span><span class="p">(</span><span class="s2">&quot;relu&quot;</span><span class="p">)(</span><span class="n">y</span><span class="p">)</span>

    <span class="n">y</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Conv2D</span><span class="p">(</span><span class="n">filters</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">strides</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">use_bias</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">)(</span><span class="n">y</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Subtract</span><span class="p">()([</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">])</span>

    <span class="c1"># Keras model</span>
    <span class="k">return</span> <span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Charging model into Example1</span>
<span class="n">kerasmodel_ex1</span><span class="o">.</span><span class="n">charge_model</span><span class="p">(</span><span class="n">model_function</span><span class="o">=</span><span class="n">dncnn</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">WARNING</span><span class="p">:</span> <span class="n">Logging</span> <span class="n">before</span> <span class="n">flag</span> <span class="n">parsing</span> <span class="n">goes</span> <span class="n">to</span> <span class="n">stderr</span><span class="o">.</span>
<span class="n">W0902</span> <span class="mi">10</span><span class="p">:</span><span class="mi">47</span><span class="p">:</span><span class="mf">13.272264</span> <span class="mi">140353946789696</span> <span class="n">keras_model</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">119</span><span class="p">]</span> <span class="n">You</span> <span class="n">have</span> <span class="n">loaded</span> <span class="n">your</span> <span class="n">model</span> <span class="kn">from</span> <span class="nn">a</span> <span class="n">python</span> <span class="n">function</span><span class="p">,</span> <span class="n">which</span> <span class="n">does</span> <span class="ow">not</span> <span class="n">hold</span> <span class="nb">any</span> <span class="n">information</span> <span class="n">about</span> <span class="n">weight</span> <span class="n">values</span><span class="o">.</span> <span class="n">Be</span> <span class="n">sure</span> <span class="n">to</span> <span class="n">train</span> <span class="n">the</span> <span class="n">network</span> <span class="n">before</span> <span class="n">running</span> <span class="n">your</span> <span class="n">tests</span><span class="o">.</span>
</pre></div>
</div>
<p>Notice the previous warning:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">W0821</span> <span class="mi">09</span><span class="p">:</span><span class="mi">12</span><span class="p">:</span><span class="mf">14.533067</span> <span class="mi">140116547233600</span> <span class="n">keras_model</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">118</span><span class="p">]</span> <span class="n">You</span> <span class="n">have</span> <span class="n">loaded</span> <span class="n">your</span> <span class="n">model</span> <span class="kn">from</span> <span class="nn">a</span> <span class="n">python</span> <span class="n">function</span><span class="p">,</span> <span class="n">which</span> <span class="n">does</span> <span class="ow">not</span> <span class="n">hold</span> <span class="nb">any</span> <span class="n">information</span> <span class="n">about</span> <span class="n">weight</span> <span class="n">values</span><span class="o">.</span> <span class="n">Be</span> <span class="n">sure</span> <span class="n">to</span> <span class="n">train</span> <span class="n">the</span> <span class="n">network</span> <span class="n">before</span> <span class="n">running</span> <span class="n">your</span> <span class="n">tests</span><span class="o">.</span>
</pre></div>
</div>
<p>since you have loaded the model without any information about its
weights, we remark that you should run a training session before
performing inference.</p>
<p>Finally, it may be the case that your architecture has additional
parameters. Consider the following example,</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">dncnn</span><span class="p">(</span><span class="n">depth</span><span class="o">=</span><span class="mi">17</span><span class="p">,</span> <span class="n">n_filters</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">n_channels</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Input</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">[</span><span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Conv2D</span><span class="p">(</span><span class="n">filters</span><span class="o">=</span><span class="n">n_filters</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="n">kernel_size</span><span class="p">,</span> <span class="n">strides</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Activation</span><span class="p">(</span><span class="s2">&quot;relu&quot;</span><span class="p">)(</span><span class="n">y</span><span class="p">)</span>

    <span class="c1"># Middle layers: Conv + ReLU + BN</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">depth</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Conv2D</span><span class="p">(</span><span class="n">filters</span><span class="o">=</span><span class="n">n_filters</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="n">kernel_size</span><span class="p">,</span> <span class="n">strides</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">,</span> <span class="n">use_bias</span><span class="o">=</span><span class="bp">False</span><span class="p">)(</span><span class="n">y</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">BatchNormalization</span><span class="p">(</span><span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">momentum</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">epsilon</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">)(</span><span class="n">y</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Activation</span><span class="p">(</span><span class="s2">&quot;relu&quot;</span><span class="p">)(</span><span class="n">y</span><span class="p">)</span>

    <span class="n">y</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Conv2D</span><span class="p">(</span><span class="n">filters</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="n">kernel_size</span><span class="p">,</span> <span class="n">strides</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">use_bias</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">)(</span><span class="n">y</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Subtract</span><span class="p">()([</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">])</span>

    <span class="c1"># Keras model</span>
    <span class="k">return</span> <span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
</pre></div>
</div>
<p>this corresponds to the same architecture as the previous DnCNN, except
that it has additional parameters, such as “depth”, “n_filters”,
“kernel_size” and “n_channels”. You can still pass these to the
charge_model function,</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">dncnn_opt_params</span><span class="p">(</span><span class="n">depth</span><span class="o">=</span><span class="mi">17</span><span class="p">,</span> <span class="n">n_filters</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">n_channels</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Input</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">n_channels</span><span class="p">])</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Conv2D</span><span class="p">(</span><span class="n">filters</span><span class="o">=</span><span class="n">n_filters</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="n">kernel_size</span><span class="p">,</span> <span class="n">strides</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Activation</span><span class="p">(</span><span class="s2">&quot;relu&quot;</span><span class="p">)(</span><span class="n">y</span><span class="p">)</span>

    <span class="c1"># Middle layers: Conv + ReLU + BN</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">depth</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Conv2D</span><span class="p">(</span><span class="n">filters</span><span class="o">=</span><span class="n">n_filters</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="n">kernel_size</span><span class="p">,</span> <span class="n">strides</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">,</span> <span class="n">use_bias</span><span class="o">=</span><span class="kc">False</span><span class="p">)(</span><span class="n">y</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">BatchNormalization</span><span class="p">(</span><span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">momentum</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">epsilon</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">)(</span><span class="n">y</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Activation</span><span class="p">(</span><span class="s2">&quot;relu&quot;</span><span class="p">)(</span><span class="n">y</span><span class="p">)</span>

    <span class="n">y</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Conv2D</span><span class="p">(</span><span class="n">filters</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="n">kernel_size</span><span class="p">,</span> <span class="n">strides</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">use_bias</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">)(</span><span class="n">y</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Subtract</span><span class="p">()([</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">])</span>

    <span class="c1"># Keras model</span>
    <span class="k">return</span> <span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">kerasmodel_ex2</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">KerasModel</span><span class="p">(</span><span class="n">model_name</span><span class="o">=</span><span class="s2">&quot;Example2&quot;</span><span class="p">,</span> <span class="n">logdir</span><span class="o">=</span><span class="s2">&quot;../../logs/Keras&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;KerasModel </span><span class="si">{}</span><span class="s2"> created succesfully.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">kerasmodel_ex2</span><span class="p">))</span>
<span class="n">kerasmodel_ex2</span><span class="o">.</span><span class="n">charge_model</span><span class="p">(</span><span class="n">model_function</span><span class="o">=</span><span class="n">dncnn_opt_params</span><span class="p">,</span> <span class="n">depth</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">7</span><span class="p">),</span> <span class="n">n_channels</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">KerasModel</span> <span class="n">Example2</span> <span class="n">created</span> <span class="n">succesfully</span><span class="o">.</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">W0902</span> <span class="mi">10</span><span class="p">:</span><span class="mi">47</span><span class="p">:</span><span class="mf">45.332327</span> <span class="mi">140353946789696</span> <span class="n">keras_model</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">119</span><span class="p">]</span> <span class="n">You</span> <span class="n">have</span> <span class="n">loaded</span> <span class="n">your</span> <span class="n">model</span> <span class="kn">from</span> <span class="nn">a</span> <span class="n">python</span> <span class="n">function</span><span class="p">,</span> <span class="n">which</span> <span class="n">does</span> <span class="ow">not</span> <span class="n">hold</span> <span class="nb">any</span> <span class="n">information</span> <span class="n">about</span> <span class="n">weight</span> <span class="n">values</span><span class="o">.</span> <span class="n">Be</span> <span class="n">sure</span> <span class="n">to</span> <span class="n">train</span> <span class="n">the</span> <span class="n">network</span> <span class="n">before</span> <span class="n">running</span> <span class="n">your</span> <span class="n">tests</span><span class="o">.</span>
</pre></div>
</div>
</div>
<div class="section" id="from-a-file">
<h2>From a file<a class="headerlink" href="#from-a-file" title="Permalink to this headline">¶</a></h2>
<p>There are two ways of charging a model from a file:</p>
<ol class="arabic simple">
<li><p>Charging an architecture (without weights) through a .json or .yaml
file. This is done through a model previously saved using
“keras.models.Model.to_json()” or “keras.models.Model.to_yaml()”
method. As an example, consider the following:</p></li>
</ol>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">net</span> <span class="o">=</span> <span class="n">dncnn</span><span class="p">()</span>
<span class="n">net</span><span class="o">.</span><span class="n">to_json</span><span class="p">(</span><span class="s2">&quot;path_to_save_your_json_file&quot;</span><span class="p">)</span>
<span class="n">net</span><span class="o">.</span><span class="n">to_yaml</span><span class="p">(</span><span class="s2">&quot;path_to_save_your_yaml_file&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>In those two cases, the network is saved without any information about
its training or weights, so you should run a training session before
using your model for inference.</p>
<ol class="arabic simple" start="2">
<li><p>Charging the complete model (weights + architecture) using a
.json/.yaml file + .hdf5 file, or only a .hdf5 file. Keras can save
either only weights or weights + architecture into a .hdf5 file. That
depends on the commands you have used, for instance,</p></li>
</ol>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">net</span> <span class="o">=</span> <span class="n">dncnn</span><span class="p">()</span>
<span class="c1"># Training of neural net</span>
<span class="n">net</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s2">&quot;model.hdf5&quot;</span><span class="p">)</span> <span class="c1"># This saves both weights and architecture.</span>
<span class="n">net</span><span class="o">.</span><span class="n">save_weights</span><span class="p">(</span><span class="s2">&quot;weights.hdf5&quot;</span><span class="p">)</span> <span class="c1"># This saves only the weights.</span>
</pre></div>
</div>
<p>To charge a model using a file, you simply need to pass it to
“<strong>charge_model</strong>” through the “model_path” parameters. An example is
shown bellow, on <a class="reference external" href="#keras-running-inference">Running Inference</a>.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Frees memory</span>
<span class="n">kerasmodel_ex1</span> <span class="o">=</span> <span class="kc">None</span>
<span class="n">kerasmodel_ex2</span> <span class="o">=</span> <span class="kc">None</span>
<span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">290</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Loads model from .hdf5 file.</span>
<span class="n">kerasmodel_ex3</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">KerasModel</span><span class="p">(</span><span class="n">model_name</span><span class="o">=</span><span class="s2">&quot;Inference_ex1&quot;</span><span class="p">,</span> <span class="n">logdir</span><span class="o">=</span><span class="s2">&quot;../../logs/Keras&quot;</span><span class="p">)</span>
<span class="n">kerasmodel_ex3</span><span class="o">.</span><span class="n">charge_model</span><span class="p">(</span><span class="n">model_path</span><span class="o">=</span><span class="s2">&quot;../../pretrained_models/Keras/dncnn/model.hdf5&quot;</span><span class="p">)</span>
</pre></div>
</div>
<pre class="literal-block">/home/efernand/repos/Summer_Internship_2019/venv/lib/python3.6/site-packages/keras/engine/saving.py:292: UserWarning: No training configuration found in save file: the model was <em>not</em> compiled. Compile it manually.
  warnings.warn('No training configuration found in save file: '</pre>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Get batch from valid_generator</span>
<span class="n">noisy_imgs</span><span class="p">,</span> <span class="n">clean_imgs</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">valid_generator</span><span class="p">)</span>
<span class="c1"># Performs inference on noisy images</span>
<span class="n">rest_imgs</span> <span class="o">=</span> <span class="n">kerasmodel_ex3</span><span class="p">(</span><span class="n">noisy_imgs</span><span class="p">)</span>
<span class="n">display_results</span><span class="p">(</span><span class="n">clean_imgs</span><span class="p">,</span> <span class="n">noisy_imgs</span><span class="p">,</span> <span class="n">rest_imgs</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">kerasmodel_ex3</span><span class="p">))</span>
</pre></div>
</div>
<img alt="../_images/output_24_0.png" src="../_images/output_24_0.png" />
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">kerasmodel_ex3</span> <span class="o">=</span> <span class="kc">None</span>
<span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">25129</span>
</pre></div>
</div>
</div>
<div class="section" id="training-a-kerasmodel">
<h2>Training a KerasModel<a class="headerlink" href="#training-a-kerasmodel" title="Permalink to this headline">¶</a></h2>
<p>To run a training session, you only need to have a dataset, such as
defined in the DatasetUsage.ipynb. Once you created a DatasetGenerator
for your training images (and possibly, for you validation images) you
can call the “<strong>train</strong>” method from KerasModel class, which takes the
following parameters,</p>
<ul class="simple">
<li><p>train_generator: any instance of a dataset generator class. This
class will yield the data pairs.</p></li>
<li><p>valid_generator: optional. Specify it if you have validation data at
hand.</p></li>
<li><p>n_epochs: number of training epochs. Default is 100.</p></li>
<li><p>n_stages: number of training batches drawn at random from the dataset
at each training epoch. Default value is 500.</p></li>
<li><p>learning_rate: constant regulating the weight updates in your model.
Default is 1e-3.</p></li>
<li><p>optimizer_name: you can specify the optimizer’s name for you model.
You can do this by lookin at the names in <a class="reference external" href="https://keras.io/optimizers/">Keras
documentation</a>. Default is “Adam”
optimizer.</p></li>
<li><p>metrics: list of metrics that will be tracked during training. There
are a couple of useful metrics implemented on <strong>evaluation</strong> module
(such as PSNR, SSIM, MSE) but you can also implement your own
following <a class="reference external" href="https://keras.io/metrics/">Keras conventions</a>.</p></li>
<li><p>kcallbacks: list of Keras callbacks. You can either use <a class="reference external" href="https://keras.io/callbacks/">Keras
default callbacks</a> or the callbacks
defined on <a class="reference internal" href="../evaluation_doc.html#module-evaluation" title="evaluation"><code class="xref py py-mod docutils literal notranslate"><span class="pre">evaluation</span></code></a> module.</p></li>
<li><p>loss: A metric that will be used in optimization as the objective
function to be minimized. You can either use <a class="reference external" href="https://keras.io/losses/">Keras
default losses</a> or the metrics
defined on <a class="reference internal" href="../evaluation_doc.html#module-evaluation" title="evaluation"><code class="xref py py-mod docutils literal notranslate"><span class="pre">evaluation</span></code></a> module.</p></li>
<li><p>valid_steps: number of validation batches drawn at each validation
epoch.</p></li>
</ul>
<p>To show how a keras model can be trained, consider the training of a
DnCNN as stated on its <a class="reference external" href="https://arxiv.org/pdf/1608.03981.pdf">original
paper</a>:</p>
<ul class="simple">
<li><p>DnCNN for gaussian denoising has depth 17, n_filters 64, kernel_size
(3, 3).</p></li>
<li><p>It is trained on <span class="math notranslate nohighlight">\(40 \times 40\)</span> patches extracted from BSDS
images, corrupted with fixed-variance gaussian noise
(<span class="math notranslate nohighlight">\(\sigma=25\)</span>, for instance).</p></li>
</ul>
<p>For evaluation, we will use a disjoint subset of BSDS, consisting on 68
images which are not present in the training dataset.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># KerasModel</span>
<span class="n">kerasmodel_ex4</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">KerasModel</span><span class="p">(</span><span class="n">model_name</span><span class="o">=</span><span class="s2">&quot;Example4&quot;</span><span class="p">,</span> <span class="n">logdir</span><span class="o">=</span><span class="s2">&quot;../../logs/Keras&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;KerasModel </span><span class="si">{}</span><span class="s2"> created succesfully.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">kerasmodel_ex4</span><span class="p">))</span>
<span class="n">kerasmodel_ex4</span><span class="o">.</span><span class="n">charge_model</span><span class="p">(</span><span class="n">model_function</span><span class="o">=</span><span class="n">dncnn_opt_params</span><span class="p">,</span> <span class="n">depth</span><span class="o">=</span><span class="mi">17</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">n_channels</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">KerasModel</span> <span class="n">Example4</span> <span class="n">created</span> <span class="n">succesfully</span><span class="o">.</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">W0902</span> <span class="mi">10</span><span class="p">:</span><span class="mi">51</span><span class="p">:</span><span class="mf">00.440434</span> <span class="mi">140353946789696</span> <span class="n">keras_model</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">119</span><span class="p">]</span> <span class="n">You</span> <span class="n">have</span> <span class="n">loaded</span> <span class="n">your</span> <span class="n">model</span> <span class="kn">from</span> <span class="nn">a</span> <span class="n">python</span> <span class="n">function</span><span class="p">,</span> <span class="n">which</span> <span class="n">does</span> <span class="ow">not</span> <span class="n">hold</span> <span class="nb">any</span> <span class="n">information</span> <span class="n">about</span> <span class="n">weight</span> <span class="n">values</span><span class="o">.</span> <span class="n">Be</span> <span class="n">sure</span> <span class="n">to</span> <span class="n">train</span> <span class="n">the</span> <span class="n">network</span> <span class="n">before</span> <span class="n">running</span> <span class="n">your</span> <span class="n">tests</span><span class="o">.</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">kerasmodel_ex4</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">train_generator</span><span class="o">=</span><span class="n">train_generator</span><span class="p">,</span>
                     <span class="n">valid_generator</span><span class="o">=</span><span class="n">valid_generator</span><span class="p">,</span>
                     <span class="n">n_epochs</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
                     <span class="n">n_stages</span><span class="o">=</span><span class="mi">465</span><span class="p">,</span>
                     <span class="n">learning_rate</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">,</span>
                     <span class="n">optimizer_name</span><span class="o">=</span><span class="s2">&quot;Adam&quot;</span><span class="p">,</span>
                     <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="n">evaluation</span><span class="o">.</span><span class="n">DnCNNSchedule</span><span class="p">(),</span>
                              <span class="n">evaluation</span><span class="o">.</span><span class="n">CheckpointCallback</span><span class="p">(</span><span class="n">kerasmodel_ex4</span><span class="p">,</span> <span class="n">monitor</span><span class="o">=</span><span class="s2">&quot;val_PSNR&quot;</span><span class="p">),</span>
                              <span class="n">evaluation</span><span class="o">.</span><span class="n">TensorboardImage</span><span class="p">(</span><span class="n">valid_generator</span><span class="p">,</span> <span class="n">kerasmodel_ex4</span><span class="p">)],</span>
                     <span class="n">loss</span><span class="o">=</span><span class="n">evaluation</span><span class="o">.</span><span class="n">mse</span><span class="p">,</span>
                     <span class="n">valid_steps</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">kerasmodel_ex4</span> <span class="o">=</span> <span class="kc">None</span>
<span class="n">tf</span><span class="o">.</span><span class="n">reset_default_graph</span><span class="p">()</span>
<span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="TfModel.html" class="btn btn-neutral float-right" title="Tensorflow Model tutorial" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="FilteringModel.html" class="btn btn-neutral float-left" title="Filtering Model tutorial" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, Eduardo Montesuma, Florian Lemarchand

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>